<!DOCTYPE html>
<html manifest="application.manifest">
<head>
	<meta charset="utf-8" />
	<title>Sample Basic MIDI Player</title>
 <!-- WebMidiAPI polyfill -->
 <script src='http://cwilso.github.io/WebMIDIAPIShim/lib/WebMIDIAPI.js'></script>
 <!-- MidiFile -->
 <script src="./../dist/MIDIFile.js" type="text/javascript"></script>
</head>
<body>
	<div class="app">
		<h1>MidiFile.js &amp; WEBMIDI API based sample MIDI player</h1>
		<h2>Test MidiFile.js</h2>
		<p>
			In order to test this MIDI player in a browser lacking MIDI support, you
				must download the
			<a href="http://jazz-soft.net/download/Jazz-Plugin/">Jazz Midi Plugin</a>.
		</p>
		<p>
			<label>Pick a MIDI file:
			<input type="file" onchange="readFile(this)" accept="audio/x-midi" /></label><br />
			<label>or choose one :
				<select onchange="downloadFile(this)">
					<option value=""></option>
					<optgroup label="Tests MIDI files"></optgroup>
						<option value="MIDIOkFormat0.mid">MIDIOkFormat0.mid</option>
						<option value="MIDIOkFormat1.mid">MIDIOkFormat1.mid</option>
						<option value="MIDIOkFormat2.mid">MIDIOkFormat2.mid</option>
						<option value="MIDIOkFormat1-lyrics.mid">MIDIOkFormat1-lyrics.mid</option>
						<option value="MIDIBadTrackHdr.mid">MIDIBadTrackHdr.mid</option>
						<option value="MIDIBadHeaderLength.mid">MIDIBadHeaderLength.mid </option>
						<option value="MIDIBadHeaderChunk.mid">MIDIBadHeaderChunk.mid</option>
						<option value="MIDIBadHeaderSMTPE.mid">MIDIBadHeaderSMTPE.mid</option>
						<option value="MIDIBadTrackLength.mid">MIDIBadTrackLength.mid</option>
						<option value="MIDIBadHeaderFormat.mid">MIDIBadHeaderFormat.mid</option>
						<option value="MIDIBadHeaderTracksNum.mid">MIDIBadHeaderTracksNum.mid</option>
					<optgroup label="HorrorPen MIDI files"></optgroup>
						<option value="HorrorPen/ItIs.mid">ItIs.mid</option>
						<option value="HorrorPen/SpiritWaltz.mid">SpiritWaltz.mid</option>
					<optgroup label="Gerardo Marset MIDI files"></optgroup>
						<option value="GerardoMarset/Hellin.mid">Hellin.mid</option>
						<option value="GerardoMarset/Backstab.mid">Backstab.mid</option>
					<optgroup label="Yubatake MIDI files"></optgroup>
						<option value="Yubatake/Battle.mid">Battle.mid</option>
						<option value="Yubatake/GoodMorning.mid">GoodMorning.mid</option>
						<option value="Yubatake/Princess.mid">Princess.mid</option>
						<option value="Yubatake/Town.mid">Town.mid</option>
						<option value="Yubatake/Dungeon.mid">Dungeon.mid</option>
						<option value="Yubatake/GoodNight.mid">GoodNight.mid</option>
						<option value="Yubatake/WinBattleBig.mid">WinBattleBig.mid</option>
						<option value="Yubatake/Fields.mid">Fields.mid</option>
						<option value="Yubatake/Labyrinth.mid">Labyrinth.mid</option>
						<option value="Yubatake/RoyalCourt.mid">RoyalCourt.mid</option>
						<option value="Yubatake/WinBattle.mid">WinBattle.mid</option>
						<option value="Yubatake/GameOver.mid">GameOver.mid</option>
						<option value="Yubatake/MainTheme.mid">MainTheme.mid</option>
						<option value="Yubatake/Temple.mid">Temple.mid</option>
					<optgroup label="Avgvst MIDI files"></optgroup>
						<option value="Avgvst/ALegacyOfLove.mid">ALegacyOfLove.mid</option>
						<option value="Avgvst/ALongRoadAhead.mid">ALongRoadAhead.mid</option>
						<option value="Avgvst/AmongstFriends.mid">AmongstFriends.mid</option>
						<option value="Avgvst/ANewComrade.mid">ANewComrade.mid</option>
						<option value="Avgvst/AtTheLake.mid">AtTheLake.mid</option>
						<option value="Avgvst/BarbarianKing.mid">BarbarianKing.mid</option>
						<option value="Avgvst/BodyCount.mid">BodyCount.mid</option>
						<option value="Avgvst/BWV1007Prelude.mid">BWV1007Prelude.mid</option>
						<option value="Avgvst/CarnalFear.mid">CarnalFear.mid</option>
						<option value="Avgvst/CoarseSands.mid">CoarseSands.mid</option>
						<option value="Avgvst/ComplexityInHerEyes.mid">ComplexityInHerEyes.mid</option>
						<option value="Avgvst/ComplexityInHerEyes2.mid">ComplexityInHerEyes2.mid</option>
						<option value="Avgvst/Courtesan.mid">Courtesan.mid</option>
						<option value="Avgvst/CrossingTheRubicon.mid">CrossingTheRubicon.mid</option>
						<option value="Avgvst/Danger.mid">Danger.mid</option>
						<option value="Avgvst/DarkContemplations.mid">DarkContemplations.mid</option>
						<option value="Avgvst/DarknessApproaches.mid">DarknessApproaches.mid</option>
						<option value="Avgvst/Dungeon.mid">Dungeon.mid</option>
						<option value="Avgvst/Endgame.mid">Endgame.mid</option>
						<option value="Avgvst/EnterTheEmperor.mid">EnterTheEmperor.mid</option>
						<option value="Avgvst/Fable.mid">Fable.mid</option>
						<option value="Avgvst/Fanfare.mid">Fanfare.mid</option>
						<option value="Avgvst/Farewell.mid">Farewell.mid</option>
						<option value="Avgvst/Finale.mid">Finale.mid</option>
						<option value="Avgvst/FreeRide.mid">FreeRide.mid</option>
						<option value="Avgvst/GameOver.mid">GameOver.mid</option>
						<option value="Avgvst/GonzoSurf.mid">GonzoSurf.mid</option>
						<option value="Avgvst/Gossiping.mid">Gossiping.mid</option>
						<option value="Avgvst/Homage.mid">Homage.mid</option>
						<option value="Avgvst/HWV56WhyDoTheNationsSoFuriouslyRageTogether.mid">HWV56WhyDoTheNationsSoFuriouslyRageTogether.mid</option>
						<option value="Avgvst/Inn.mid">Inn.mid</option>
						<option value="Avgvst/JustAnAverageDay2.mid">JustAnAverageDay2.mid</option>
						<option value="Avgvst/JustAnAverageDay.mid">JustAnAverageDay.mid</option>
						<option value="Avgvst/KunioShuffle.mid">KunioShuffle.mid</option>
						<option value="Avgvst/LeftAlone.mid">LeftAlone.mid</option>
						<option value="Avgvst/LettingGo.mid">LettingGo.mid</option>
						<option value="Avgvst/LoversChronicle.mid">LoversChronicle.mid</option>
						<option value="Avgvst/Lullaby.mid">Lullaby.mid</option>
						<option value="Avgvst/MarchOfDetermination.mid">MarchOfDetermination.mid</option>
						<option value="Avgvst/MarchOfHope.mid">MarchOfHope.mid</option>
						<option value="Avgvst/Mingling.mid">Mingling.mid</option>
						<option value="Avgvst/Minotaur.mid">Minotaur.mid</option>
						<option value="Avgvst/MountainMan.mid">MountainMan.mid</option>
						<option value="Avgvst/MourningGlory.mid">MourningGlory.mid</option>
						<option value="Avgvst/Mushrooms.mid">Mushrooms.mid</option>
						<option value="Avgvst/NighttideWaltz.mid">.mid</option>
						<option value="Avgvst/Opening.mid">Opening.mid</option>
						<option value="Avgvst/Ostrich.mid">Ostrich.mid</option>
						<option value="Avgvst/Overworld.mid">Overworld.mid</option>
						<option value="Avgvst/ParadigmShifter.mid">ParadigmShifter.mid</option>
						<option value="Avgvst/Plateau.mid">Plateau.mid</option>
						<option value="Avgvst/PopPunk.mid">PopPunk.mid</option>
						<option value="Avgvst/PsychoticGarden.mid">PsychoticGarden.mid</option>
						<option value="Avgvst/RawMix.mid">RawMix.mid</option>
						<option value="Avgvst/RebelsBe.mid">RebelsBe.mid</option>
						<option value="Avgvst/Reminiscing.mid">Reminiscing.mid</option>
						<option value="Avgvst/Reunion.mid">Reunion.mid</option>
						<option value="Avgvst/Rift.mid">Rift.mid</option>
						<option value="Avgvst/RoadTrip.mid">RoadTrip.mid</option>
						<option value="Avgvst/RustyBossManTussle.mid">RustyBossManTussle.mid</option>
						<option value="Avgvst/RV610FecitPotentiam.mid">RV610FecitPotentiam.mid</option>
						<option value="Avgvst/Sanctuary.mid">Sanctuary.mid</option>
						<option value="Avgvst/Solitude.mid">Solitude.mid</option>
						<option value="Avgvst/TheEmpire.mid">TheEmpire.mid</option>
						<option value="Avgvst/TimewornPagoda.mid">TimewornPagoda.mid</option>
						<option value="Avgvst/TogetherAgain.mid">TogetherAgain.mid</option>
						<option value="Avgvst/Tokyo.mid">Tokyo.mid</option>
						<option value="Avgvst/Town.mid">Town.mid</option>
						<option value="Avgvst/Valentine.mid">Valentine.mid</option>
						<option value="Avgvst/Valentine2.mid">Valentine2.mid</option>
						<option value="Avgvst/Victory.mid">Victory.mid</option>
						<option value="Avgvst/Whipped.mid">Whipped.mid</option>
						<option value="Avgvst/WindBlownRose.mid">WindBlownRose.mid</option>
						<option value="Avgvst/Wonderland.mid">Wonderland.mid</option>
						<option value="Avgvst/Z339HereTheDeitiesApprove.mid">Z339HereTheDeitiesApprove.mid</option>
				</select>
			</label>
		</p>
		<h2>Usefull</h2>
		<p>
			<a href="http://webaudio.github.io/web-midi-api/">WebMidi spec</a><br />
			<a href="http://cwilso.github.io/WebMIDIAPIShim/">WebMidi polyfill</a><br />
			<a href="http://www.sonicspot.com/guide/midifiles.html">Midi File Specs</a><br />
			<a href="http://www.onicos.com/staff/iz/formats/smf006.html">Midi File Specs + Samples</a><br />
			<a href="http://gnese.free.fr/Projects/KaraokeTime/Fichiers/karfaq.html">Kar File Specs</a><br />
			<a href="http://www.personal.kent.edu/~sbirch/Music_Production/MP-II/MIDI/midi_protocol.htm">Midi File Specs</a><br />
			<a href="http://en.wikipedia.org/wiki/General_MIDI">General MIDI overview</a><br />
			<a href="http://www.karaokar.com/index.php/telecharger/sound-fonts">Soundfonts bank</a><br />
			<a href="http://theremin.music.uiowa.edu/">Free sounds of complete scales for various instruments</a><br />
			<a href="http://www.midimountain.com/midi/midi_note_numbers.html">MIDI note numbers</a><br />
			<a href="http://home.roadrunner.com/~jgglatt/tech/midifile.htm">MIDI file format</a><br />
			<a href="http://www.indiana.edu/~emusic/cntrlnumb.html">MIDI controller events</a><br />
		</p>
	</div>
	<script type="text/javascript">
		var midiAccess;
		// Requesting Midi Access
		navigator.requestMIDIAccess().then( function onsuccesscallback( access ) {
		  midiAccess = access;
		},function onerrorcallback( err ) {
		  console.log("uh-oh! Something went wrong!  Error code: " + err.code );
		});

		// File handlers
		function readFile(input) {
			var reader = new FileReader();
			reader.readAsArrayBuffer(input.files[0]);
			reader.onloadend = function(event) {
				playFile(event.target.result);
   		}
   	}
		function downloadFile(input) {
			if(!input.value)
				return;
			var oReq = new XMLHttpRequest();
			oReq.open("GET", "../sounds/"+input.value, true);
			oReq.responseType = "arraybuffer";
			oReq.onload = function (oEvent) {
				playFile(oReq.response);
			};
			oReq.send(null);
   	}

   // file player
		var midiFile, m;
		function playFile(buffer) {
			var midiOutput;
			var midiOutputIDs = [];
			// testing output
			if(midiAccess) {
				midiAccess.outputs.forEach(function(port){
					console.log("Available output:", port.name);
					midiOutputIDs.push(port.id);
				});
				midiOutput = midiAccess.outputs.get(midiOutputIDs[0]);
				if (midiOutput) {
					console.log("Selected output:", midiOutput.name);
				} else {
					console.log("No MIDI output devices connected.");
				}
			} else {
				console.log('No access to MIDI output.');
			}
			// creating the MidiFile instance
			midiFile = new MIDIFile(buffer);
			var events = midiFile.getMidiEvents();
			var curTime = performance.now();
			var eventBytes  =  [];
			for(var i = 0, j = events.length; i < j; i++) {
				eventBytes = [(events[i].subtype << 4) + events[i].channel, events[i].param1];
				if (events[i].param2) {eventBytes.push(events[i].param2);}
				midiOutput && midiOutput.send(eventBytes, curTime + events[i].playTime);
			}
			console.log('Events read, playTime: ' + events[events.length - 1].playTime +
				', tracks:' + midiFile.tracks.length + '.');
			document.getElementById('hexa').contentWindow.postMessage(midiFile.getContent(), '*');
   	}
	</script>
	<iframe src="http://hexa.insertafter.com" width="100%" height="800px;" id="hexa"></iframe>
</body>
</html>
